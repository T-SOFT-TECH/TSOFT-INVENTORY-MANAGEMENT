<!-- receipt.component.html -->
<div class="bg-white dark:bg-surface-dark-secondary rounded-xl shadow-lg overflow-hidden">
  <!-- Header -->
  <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">
          Receipt
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          Invoice #{{ saleData?.invoiceNumber || 'N/A' }}
        </p>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-500 dark:text-gray-400">
          Date: {{ saleData?.date | date:'medium' }}
        </p>
        <p class="inline-flex items-center mt-1 px-2.5 py-0.5 rounded-full text-xs font-medium"
           [ngClass]="{
             'bg-success-100 text-success-800 dark:bg-success-900/20 dark:text-success-400': saleData?.paymentStatus === 'paid',
             'bg-warning-100 text-warning-800 dark:bg-warning-900/20 dark:text-warning-400': saleData?.paymentStatus === 'pending',
             'bg-error-100 text-error-800 dark:bg-error-900/20 dark:text-error-400': saleData?.paymentStatus === 'failed'
           }">
          {{ saleData?.paymentStatus | titlecase }}
        </p>
      </div>
    </div>
  </div>

  <!-- Content - Simplified for better performance -->
  <div class="p-4">
    <!-- Customer Info -->
    @if (saleData?.customer) {
      <div class="mb-4 bg-gray-50 dark:bg-gray-800/30 p-3 rounded-lg">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Customer</h3>
        <p class="text-gray-900 dark:text-white font-medium">{{ saleData?.customer?.name || 'N/A' }}</p>
        <div class="flex flex-col gap-0.5 mt-1">
          @if (saleData?.customer?.email) {
            <p class="text-xs text-gray-600 dark:text-gray-300 flex items-center">
              <span class="material-icons text-xs mr-1">email</span>
              {{ saleData?.customer?.email }}
            </p>
          }
          @if (saleData?.customer?.phone) {
            <p class="text-xs text-gray-600 dark:text-gray-300 flex items-center">
              <span class="material-icons text-xs mr-1">phone</span>
              {{ saleData?.customer?.phone }}
            </p>
          }
        </div>
      </div>
    }

    <!-- Products Section in the Receipt Component -->
    <div class="mb-4">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Items</h3>
      <div class="space-y-2">
        @if (saleData?.saleItems?.length) {
          @for (item of saleData?.saleItems; track $index) {
            <div class="flex justify-between border-b border-gray-100 dark:border-gray-800 pb-2">
              <div>
                <p class="text-sm text-gray-900 dark:text-white">
                  {{ item.product?.name}}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {{ item.quantity || 1 }} Ã— {{ formatCurrency(getItemPrice(item)) }}
                </p>
              </div>
              <p class="text-sm font-medium text-gray-900 dark:text-white">
                {{ formatCurrency(calculateItemTotal(item)) }}
              </p>
            </div>
          }
        } @else {
          <div class="text-center py-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <p class="text-sm text-gray-500 dark:text-gray-400">
              No items found in this sale
            </p>
          </div>
        }
      </div>
    </div>

    <!-- Summary -->
    <div class="bg-gray-50 dark:bg-gray-800/30 p-3 rounded-lg">
      <div class="flex justify-between text-sm mb-1">
        <span class="text-gray-600 dark:text-gray-400">Subtotal:</span>
        <span class="text-gray-900 dark:text-white">{{ formatCurrency(saleData?.subtotal) }}</span>
      </div>
      <div class="flex justify-between text-sm mb-2">
        <span class="text-gray-600 dark:text-gray-400">Tax ({{settingService.settings()?.invoice?.taxRate}}):</span>
        <span class="text-gray-900 dark:text-white">{{ formatCurrency(saleData?.tax)}}</span>
      </div>
      <div class="flex justify-between text-base font-bold pt-2 border-t border-gray-200 dark:border-gray-700">
        <span class="text-gray-900 dark:text-white">Total:</span>
        <span class="text-primary-600 dark:text-primary-400">{{ formatCurrency(saleData?.totalAmount) }}</span>
      </div>
      <div class="flex justify-between text-sm pt-2">
        <span class="text-gray-600 dark:text-gray-400">Payment Method:</span>
        <span class="text-gray-900 dark:text-white capitalize">{{ saleData?.paymentMethod || 'Cash' }}</span>
      </div>
    </div>
  </div>

  <!-- Footer with Actions -->
  <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-2 justify-end">
    <button
      (click)="printReceipt()"
      class="inline-flex items-center px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg
             hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">
      <span class="material-icons text-sm mr-1">print</span>
      Print
    </button>

    <button
      (click)="downloadPdf()"
      class="inline-flex items-center px-3 py-1.5 bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-lg
             hover:bg-primary-200 dark:hover:bg-primary-800/40 transition-colors text-sm">
      <span class="material-icons text-sm mr-1">download</span>
      Download
    </button>

    <button
      (click)="emailReceipt()"
      class="inline-flex items-center px-3 py-1.5 bg-primary-500 text-white rounded-lg
             hover:bg-primary-600 transition-colors text-sm">
      <span class="material-icons text-sm mr-1">email</span>
      Email
    </button>

    <button
      (click)="printToPos()"
      class="inline-flex items-center px-3 py-1.5 bg-red-500 text-white rounded-lg
         hover:bg-red-600 transition-colors text-sm">
      <span class="material-icons text-sm mr-1">bug_report</span>
      Test PDF
    </button>

  </div>
</div>

<!-- Preview Section (Only loads when requested) -->
@if (!previewUrl() && !isPreviewLoading()) {
  <div class="mt-6 text-center">
    <button
      (click)="loadPreview()"
      class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-lg
             border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
      <span class="material-icons text-sm mr-1.5">visibility</span>
      Load PDF Preview
    </button>
  </div>
} @else if (isPreviewLoading()) {
  <div class="mt-6 flex justify-center">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
  </div>
} @else if (previewUrl()) {
  <div class="mt-6">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">PDF Preview</h3>
    <div class="aspect-[8.5/11] bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden">
      <iframe [src]="previewUrl() ?? '' | safeResourceUrl" class="w-full h-full" frameborder="0"></iframe>
    </div>
  </div>
}
